    <!DOCTYPE HTML>
    <head>
        <meta charset="UTF-8">
        <title> TI Data Hub </title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/moment.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
        <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>
        <script type="text/javascript" src="js/chartjs-plugin-streaming.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </head>
    <header>
        <section id="header">
            <div class="wrapper">
            <nav>
                <ul class="main-nav">
                <li><a href="https://www.ti.com/" class="logo" ><img src="images/logo.png" alt="tilogo" class="img-responsive"></a></li>
                <li class="nav"><a href="oscilloscope.html"class='active'>Oscilloscope</a></li>
                <li class="nav"><a href="voltmeter.html">Voltmeter</a></li>
                <li class="nav"><a href="logic.html">Logic Analyzer</a></li>
                <li class="nav"><a href="waveform.html">Waveform Generator</a></li>
                <li class="nav"><a href="power.html">Power Supply</a></li>
                </ul>
            </nav>
            </div>
        </section>
    </header>
    <body>
        <div class="container h-100">
            <div class="row h-100">
                <div class="col-md-12"> 
                    <div class="row h-100 main">
                        <div class="col-md-12 m-0 p-0 h-100 float-left border border-secondary">
                            <div class="row">
                                <div class="col-md-12">
                                    <canvas id="oscilloscopeChart" class="w-100 bg-dark-custom border border border-secondary"></canvas>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="onData()">Enable Oscilloscope</button>
                            <button type="button" class="btn btn-primary" onclick="offData()">Disable Oscilloscope</button>
                            <button type="button" class="btn btn-primary" id="btnExportToCsv" onclick="convertToCSV()">Export Data</button>
                            <form id="settings-form">
                                <div class="row h-25">
                                    <div class="col-md-6 h-100">
                                        <div class="row m-0">
                                            <div class="col-md-12 border border-secondary">
                                                <h3 class="text-center"> Timing Characteristics </h1>
                                            </div>
                                        </div>
                                        
                                            <div class="row m-0">
                                                <div class="col-md-12 border border-secondary">
                                                    <div class="input-group input-group-sm mb-3">
                                                        <div class="input-group-prepend">
                                                        <span class="input-group-text" id="inputGroup-sizing-sm">Frequency</span>
                                                        </div>
                                                        <input type="text" id="freq-input" class="form-control" aria-label="Small" aria-describedby="freq-input" value="1">
                                                        <input type="range" class="form-range" min="1" max="512" step="1" value="1" id="freq-range">
                                                    </div>
                                                    <div class="input-group input-group-sm mb-3">
                                                        <div class="input-group-prepend">
                                                        <span class="input-group-text" id="inputGroup-sizing-sm">Period</span>
                                                        </div>
                                                        <input disabled type="text" class="form-control" id="period-input" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
                                                    </div>
                                                    <div class="input-group input-group-sm mb-3">
                                                        <div class="input-group-prepend">
                                                        <span class="input-group-text" id="inputGroup-sizing-sm">Duty Cycle</span>
                                                        </div>
                                                        <input disabled type="text" class="form-control" id="duty-cycle-input" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
                                                    </div>
                                                    <div class="input-group input-group-sm mb-3">
                                                        <div class="input-group-prepend">
                                                        <span class="input-group-text" id="inputGroup-sizing-sm">Rise Time</span>
                                                        </div>
                                                        <input disabled type="text" class="form-control" id="rise-time-input" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
                                                    </div>
                                                    <div class="input-group input-group-sm mb-3">
                                                        <div class="input-group-prepend">
                                                        <span class="input-group-text" id="inputGroup-sizing-sm">Fall Time</span>
                                                        </div>
                                                        <input disabled type="text" class="form-control" id="fall-time-input"aria-label="Small" aria-describedby="inputGroup-sizing-sm">
                                                    </div>
                                                </div>
                                            </div>
                                    
                                        
                                    </div>
                                    <div class="col-md-6 h-100">
                                        <div class="row m-0">
                                            <div class="col-md-12 border border-secondary">
                                                <h3 class="text-center"> Voltage Characteristics </h1>
                                            </div>
                                        </div>
                                        <div class="row m-0">
                                            <div class="col-md-12 border border-secondary">
                                                <div class="input-group input-group-sm mb-3">
                                                    <div class="input-group-prepend">
                                                    <span class="input-group-text" id="inputGroup-sizing-sm">Amplitude</span>
                                                    </div>
                                                    <input type="text" id="amplitude-input" class="form-control" aria-label="Small" aria-describedby="amplitude-input" value="1">
                                                    <input type="range" class="form-range" min="0.1" max="12" step="0.1" value="1" id="amplitude-range">

                                                </div>
                                                <div class="input-group input-group-sm mb-3">
                                                    <div class="input-group-prepend">
                                                    <span class="input-group-text" id="inputGroup-sizing-sm">Maximum Voltage</span>
                                                    </div>
                                                    <input disabled type="text" id="max-voltage-input" class="form-control" aria-label="Small" value="0" aria-describedby="inputGroup-sizing-sm">
                                                </div>
                                                <div class="input-group input-group-sm mb-3">
                                                    <div class="input-group-prepend">
                                                    <span class="input-group-text" id="inputGroup-sizing-sm">Minimum Voltage</span>
                                                    </div>
                                                    <input disabled type="text" id="min-voltage-input" class="form-control" aria-label="Small" value="0" aria-describedby="inputGroup-sizing-sm">
                                                </div>
                                                <div class="input-group input-group-sm mb-3">
                                                    <div class="input-group-prepend">
                                                    <span class="input-group-text" id="inputGroup-sizing-sm">Median Voltage</span>
                                                    </div>
                                                    <input disabled type="text" id="median-voltage-input" value="0" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
                                                </div>
                                                <div class="input-group input-group-sm mb-3">
                                                    <div class="input-group-prepend">
                                                    <span class="input-group-text" id="inputGroup-sizing-sm">Mean Voltage</span>
                                                    </div>
                                                    <input disabled type="text" id="mean-voltage-input" value="0" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script>
        // FROM https://stackoverflow.com/a/995193/4352298
        (function($) {
            $.fn.inputFilter = function(inputFilter) {
                return this.on("input keydown keyup mousedown mouseup select contextmenu drop", function() {
                if (inputFilter(this.value)) {
                    this.oldValue = this.value;
                    this.oldSelectionStart = this.selectionStart;
                    this.oldSelectionEnd = this.selectionEnd;
                } else if (this.hasOwnProperty("oldValue")) {
                    this.value = this.oldValue;
                    this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
                } else {
                    this.value = "";
                }
                });
            };
            }(jQuery));

            $("#settings-form input").inputFilter(function(value) {
                return /^-{0,1}\d*\.{0,1}\d*$/.test(value);            
            });

        var ctx = document.getElementById('oscilloscopeChart').getContext('2d');
        var chart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Voltage',
                pointStyle: 'line',
                data: [],
                steppedLine: false,
                fill: false,
                borderColor: 'rgb(14, 173, 105)',
            }],
        },
        options: {
            plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                enabled: true,
                                mode: 'x'
                            }
                        }
            },
            title: {
                display: true,
                text: 'Oscilloscope',
                fontColor: 'rgb(255, 255, 255)',
            },
            legend: {
                labels: {
                    defaultFontFamily:  "'Roboto', 'Franklin Gothic Medium', 'Tahoma', 'sans-serif",
                    fontColor: 'rgb(255, 255, 255)',
                }
            },
            color: 'rgb(255, 255, 255)',
            scales: {
                yAxes: [{
                    gridLines: {
                        drawOnChartArea: true,
                        color: 'rgb(255,255,255)',
                    },
                    ticks: {
                        fontColor: 'rgb(255, 255, 255)',
                        beginAtZero: true,
                                callback: function(value, index, values) {
                                    return value + ' V';
                                }
                    },
                    scaleLabel: {
                                display: true,
                                labelString: 'Voltage'
                    },
                    type: 'linear'
                }],
                xAxes: [{
                    gridLines: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        beginAtZero: true,
                        fontColor: 'rgb(255, 255, 255)',
                        beginAtZero: true,
                        callback: function(value, index, values) {
                            return value;
                        }
                    },
                    type: 'realtime',
                    scaleLabel: {
                        display: true,
                        labelString: 'Time'
                    },
                    realtime: {
                        onRefresh: function(chart) {
                            chart.data.datasets.forEach(function(dataset) {
                                xVal = Date.now();
                                yVal = plotSine();
                                dataset.data.push({
                                    x: xVal,
                                    y: yVal,
                                    
                                });
                                
                                storeChartData(xVal, yVal);
                            });
                        },
                        delay: 2000,
                    }
                }]
            },
        }});
        
        dataset = [];
        var x = 1;
        var frequency = 1;
        var amplitude = 1;
        var period = 1 / frequency;
        var max_volt = 0, min_volt = 0;

        function updateVars() {
            frequency = parseFloat($("#freq-input").val());
            
            frequency = frequency <= 0 ? 0.01 : frequency;
            amplitude = parseFloat($("#amplitude-input").val());

        }

        var display_data = true;

        // funciton plotSine will calculate the y value for the sine curve
        function plotSine() {
            switchX();
            if(display_data) {
            y_val = amplitude * Math.sin(x/frequency)
            if(y_val > max_volt) {
                max_volt = y_val;
                $("#max-voltage-input").val(y_val.toFixed(2));
                updateStats();
            }
            if(y_val < min_volt) {
                min_volt = y_val;
                $("#min-voltage-input").val(y_val.toFixed(2));
                updateStats();
            }
            dataset.push(y_val);
            return y_val;
            }
        }

        function median() {
            array = dataset.sort();
            if (array.length % 2 === 0) { // array with even number elements
                return (array[array.length/2] + array[(array.length / 2) - 1]) / 2;
            }
            else {
                return array[(array.length - 1) / 2]; // array with odd number elements
            }
        }

        function mean() {
            sum = 0;
            dataset.forEach(element => sum += element);
            return sum/dataset.length;
        }

        function updateStats() {
            $("#mean-voltage-input").val(mean());
            $("#median-voltage-input").val(median());
        }

        // function switchX will osillate between -1 and 1
        function switchX() {
            if(x == amplitude){
                x = -1 * amplitude;
            } else {
                x = amplitude;
            }
        }

        $("#settings-form :input").change(function() {
            if (this.id.includes("range")) { // if a slider
                $("#" + this.id.substring(0, this.id.indexOf("range")) + "input").val(this.value);
            } else if (this.id.includes("input")) { // if a input box
                $("#" + this.id.substring(0, this.id.indexOf("input")) + "range").val(this.value);
            }
            updateVars();
        });

        function onReceive(event) {
            window.myChart.config.data.datasets[event.index].data.push({
                x: event.timestamp,
                y: event.value
            });
            window.myChart.update({
                preservation: true
            });
        }

        var timeoutIDs = [];

        function startFeed(index) {
            var receive = function() {
                onReceive({
                    index: index,
                    timestamp: Date.now(),
                    value: randomScalingFactor()
                });
                timeoutIDs[index] = setTimeout(receive, Math.random() * 1000 + 500);
            }
            timeoutIDs[index] = setTimeout(receive, Math.random() * 1000 + 500);
        }

        // toggle the data on
        function onData() {
            chart.options.plugins.streaming.pause = false;
            chart.update();
            display_data = true;
        }

        // toggle the data off
        function offData() {
            
            chart.options.plugins.streaming.pause = true;
            chart.update();
            display_data = false;
            console.log('stop');
        }

        chartData = [];
        
        function storeChartData(xVal, yVal) {
            chartData.push({x:xVal, y:yVal});
        }
        
        function convertToCSV() {
                const csvRows = [];
                const headers = ["Time,Voltage"];
                csvRows.push(headers.join(','));
                for(const row of chartData) {
                    csvRows.push([row.x, row.y].join(','));
                }
                download(csvRows.join('\n'));

        }

        // how to download the data to a csv
        const download = function(data) {
            const blob = new Blob([data], {type:'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href',url);
            a.setAttribute('download', 'download.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>