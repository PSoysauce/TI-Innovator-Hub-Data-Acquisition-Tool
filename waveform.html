<!DOCTYPE HTML>
 - amplitude / 2<head>
    <meta charset="UTF-8">
    <title> TI Data Hub </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript" src="js/moment.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
    <script type="text/javascript" src="js/chartjs-plugin-streaming.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</head>
<header>
    <section id="header">
        <div class="wrapper">
           <nav>
             <ul class="main-nav">
               <li><a href="https://www.ti.com/" class="logo"><img src="images/logo.png" alt="tilogo" class="img-responsive"></a href="https://www.ti.com/"></li>
               <li><a href="oscilloscope.html">Oscilloscope</a></li>
               <li><a href="voltmeter.html">Voltmeter</a></li>
               <li><a href="logic.html">Logic Analyzer</a></li>
               <li><a href="waveform.html"class='active'>Waveform Generator</a></li>
               <li><a href="power.html">Power Supply</a></li>
             </ul>
           </nav>
        </div>
      </section>
</header>
<body>
    <div class="container h-100">
        <div class="row h-100">
            <div class="col-md-12"> 
                <div class="row h-100 main">
                    <div class="col-md-12 m-0 p-0 h-100 float-left border border-secondary">
                        <div class="row">
                            <div class="col-md-12">
                                <canvas id="idealChart" class="w-100 border border-secondary"></canvas>
                                <script>
                                </script>
                            </div>
                        </div>
                        <div>
                            <form id="settings-form">
                                <div class="row m-0">
                                    <div class="col-md-12 border border-secondary">
                                        <h3 class="text-center"> Timing Characteristics </h1>
                                    </div>
                                </div>
                                <div class="row m-0">
                                    <div class="col-md-12 border border-secondary">
                                        <div class="input-group input-group-sm mb-3 mt-3">
                                          <div class="input-group-prepend">
                                            <span class="input-group-text">Type</span>
                                          </div>
                                          <select class="form-select form-select-sm">
                                            <option class="dropdown-item" value="square" selected>Square</option>
                                            <option class="dropdown-item" value="sine">Sine</option>
                                            <option class="dropdown-item" value="sawtooth">Sawtooth</option>
                                          </select>
                                        </div>
                                        <div class="input-group input-group-sm mb-3">
                                            <div class="input-group-prepend">
                                              <span class="input-group-text">Frequency (Hz)</span>
                                            </div>
                                            <input type="text" id="freq-input" class="form-control" aria-label="Small" aria-describedby="freq-input" value="2">
                                        </div>
                                        <div class="input-group input-group-sm mb-3">
                                            <div class="input-group-prepend">
                                              <span class="input-group-text">DAC Frequency (Hz)</span>
                                            </div>
                                            <input type="text" id="dac-freq-input" class="form-control" aria-label="Small" aria-describedby="dac-freq-input" value="1024">
                                        </div>
                                        <div class="input-group input-group-sm mb-3">
                                            <div class="input-group-prepend">
                                              <span class="input-group-text">Amplitude (V)</span>
                                            </div>
                                            <input type="text" id="amplitude-input" class="form-control" aria-label="Small" aria-describedby="amplitude-input" value="1">
                                        </div>
                                        <div class="input-group input-group-sm mb-3">
                                            <div class="input-group-prepend">
                                              <span class="input-group-text">Bias (V)</span>
                                            </div>
                                            <input type="text" id="bias-input" class="form-control" aria-label="Small" aria-describedby="amplitude-input" value="0.5">
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // FROM https://stackoverflow.com/a/995193/4352298
        (function($) {
          $.fn.inputFilter = function(inputFilter) {
            return this.on("input keydown keyup mousedown mouseup select contextmenu drop", function() {
              if (inputFilter(this.value)) {
                this.oldValue = this.value;
                this.oldSelectionStart = this.selectionStart;
                this.oldSelectionEnd = this.selectionEnd;
              } else if (this.hasOwnProperty("oldValue")) {
                this.value = this.oldValue;
                this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
              } else {
                this.value = "";
              }
            });
          };
        }(jQuery));

        $("#settings-form input").inputFilter(function(value) {
            return /^\d*\.{0,1}\d*$/.test(value);            
        });

        var chart = new Chart(document.getElementById("idealChart").getContext('2d'), {
            type: 'line',
            data: {
                datasets: [{
                    pointStyle: 'line',
                    label: "Ideal voltage",
                    data: [],
                    steppedLine: true,
                    fill: false,
                    borderColor: 'rgb(14, 173, 105)',
                }]
            },
            options: {
                title: {
                    display: true,
                    text: 'Ideal generated signal'
                },
                scales: {
                    yAxes: [{
                        gridLines: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            beginAtZero: true,
                            callback: function(value, index, values) {
                                return value + ' V';
                            }
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Voltage'
                        },
                        type: 'linear'
                    }],
                    xAxes: [{
                        ticks: {
                            beginAtZero: true,
                            callback: function(value, index, values) {
                                return value + 's';
                            }
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        },
                        type: 'linear'
                    }]
                }
            }
        });

        var freq, amplitude, dacFreq, type, bias;
        function updateVars() {
            freq = parseFloat($("#freq-input").val());
            freq = freq == 0 ? 0.01 : freq;
            amplitude = parseFloat($("#amplitude-input").val());
            dacFreq = parseFloat($("#dac-freq-input").val());
            dacFreq = dacFreq == 0 ? 0.01 : dacFreq;
            type = $("#settings-form option:selected").index();
            bias = parseFloat($("#bias-input").val());
        }

        function trimNum(num) {
            return Math.round(num * 10 ** 7) / 10 ** 7;
        }

        function setIdealChart() {
            data = [];
            var sampleLength = dacFreq > freq ? dacFreq / freq : dacFreq;
            switch (type) {
                // Square
                case 0: 
                    if (freq < 1) {
                        sampleLength = dacFreq / freq;
                    }
                    cycleLength = trimNum(1 / freq);
                    for (i = 0; i < sampleLength; i++) {
                        sec = trimNum(i / dacFreq);
                        cycleCount = Math.floor(trimNum(sec / cycleLength));
                        sec -= cycleCount * cycleLength;
                        if (sec <= cycleLength / 2) {
                            data.push(bias + amplitude / 2);
                        } else {
                            data.push(bias - amplitude / 2);
                        }
                    }
                    break;
                // Sine
                case 1:
                    dx = 2 * Math.PI * freq / dacFreq;
                    if (freq < 1) {
                        sampleLength = dacFreq / freq;
                        dx = 2 * Math.PI / sampleLength;
                        console.log(sampleLength);
                    }
                    for (i = 0; i < sampleLength; i++) {
                        data.push(amplitude / 2 * Math.sin(i * dx) + bias);
                    }
                    break;
                // Sawtooth
                case 2:
                    dx = amplitude / freq;
                    if (dacFreq > freq) {
                        sampleLength = dacFreq;
                        dx = amplitude / sampleLength;
                    }
                    if (freq < 1) {
                        sampleLength = dacFreq / freq;
                    }
                    cycleLength = trimNum(1 / freq);
                    for (i = 0; i < sampleLength; i++) {
                        sec = trimNum(i / sampleLength);
                        cycleCount = Math.floor(trimNum(sec / cycleLength));
                        sec -= cycleCount * cycleLength;
                        data.push(sec / cycleLength * amplitude + bias - amplitude / 2);
                    }
                    break;
            }

            chart.data.datasets[0].data = [];
            cycleIndex = 0;
            length = freq >= 1 ? dacFreq : sampleLength;
            while (chart.data.datasets[0].data.length <= length) {
                for (i = 0; i < sampleLength; i++) {
                    chart.data.datasets[0].data.push({x: trimNum((cycleIndex * sampleLength + i) / dacFreq), y: trimNum(data[i])});
                    if (chart.data.datasets[0].data.length > length) {
                        break;
                    }
                }
                cycleIndex++;
            }
            chart.update();
        }

        $("#settings-form :input").change(function() {
            updateVars();
            setIdealChart();
        });
        
        $(document).ready(function() {
            updateVars();
            setIdealChart();
        });
    </script>    
</body>
